<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Giv akt, kurven!</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="description" content="" />
</head>

<body>
    <canvas id="game" width="1000" height="1000"></canvas>
    <script type="text/javascript">
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');

        const uri = 'ws://' + location.host + '/join/observer';
        const ws = new WebSocket(uri);
        var my_id = null;
        var bodies = {};


        function handleEvent(event) {
            switch (event.event.event_type) {
                case 'AssignPlayerId':
                    my_id = event.event.player_id;
                    break;
                case 'UpdateState':
                    handleUpdateEvent(event.event);
                    break;
                case 'GameOver':
                    handleGameOverEvent(event.event);
                    break;
            }
        }

        function handleUpdateEvent(event) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // dark blue background
            ctx.fillStyle = '#000033';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            for (const [player_id, player] of Object.entries(event.new_state.players)) {
                if (!bodies[player_id]) {
                    bodies[player_id] = [];
                }

                for (const blob of player.body) {
                    bodies[player_id].push(blob);
                }

                if (player_id == my_id) {
                    ctx.fillStyle = '#ff0000';
                } else {
                    ctx.fillStyle = '#00ccff';
                }
                for (const blob of bodies[player_id]) {
                    ctx.beginPath();
                    ctx.arc(blob.position.x, blob.position.y, blob.size, 0, 2 * Math.PI);
                    ctx.fill();
                }

                // Draw heads of alive players
                if (player.is_alive) {
                    head = player.head;
                    ctx.fillStyle = '#ffcc00';
                    ctx.beginPath();
                    ctx.arc(head.position.x, head.position.y, head.size, 0, 2 * Math.PI);
                    ctx.fill();
                }
            }

        }

        function handleGameOverEvent(event) {
            ctx.font = "24px serif";
            ctx.fillStyle = "#ffffff";
            ctx.fillText("Winner: " + event.winner, 40, 40);
        }

        ws.onmessage = function (msg) {
            handleEvent(JSON.parse(msg.data));
        };

        function sendAction(ws, action) {
            ws.send('{"event_type": "Action", "action": "' + action + '"}');
        }

        const keyLeft = 'a';
        const keyRight = 'd';
        var leftDown = false;
        var rightDown = false;
        var action = 'Forward';

        function updateAction(ws, leftDown, rightDown) {
            var oldAction = action;

            if (leftDown && rightDown) action = 'Forward'
            else if (leftDown) action = 'Left'
            else if (rightDown) action = 'Right'
            else action = 'Forward'

            if (oldAction != action) sendAction(ws, action);
        }

        ws.onopen = function () { console.log('Connected') };
        ws.onclose = function () { console.log('Disconnected'); };

        document.addEventListener('keydown', function (event) {
            switch (event.key) {
                case keyLeft:
                    leftDown = true;
                    break;
                case keyRight:
                    rightDown = true;
                    break;
                default:
                    return;
            }
            updateAction(ws, leftDown, rightDown);
        });
        document.addEventListener('keyup', function (event) {
            switch (event.key) {
                case keyLeft:
                    leftDown = false;
                    break;
                case keyRight:
                    rightDown = false;
                    break;
                default:
                    return;
            }
            updateAction(ws, leftDown, rightDown);
        });
    </script>
</body>

</html>